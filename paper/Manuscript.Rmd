---
title: "How residence time constrains diversity"
author: "Ken Locey, Jay Lennon"
date: "May 31, 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## INTRODUCTION

**P1**—Biological and ecological change is marked by time. From rates of metabolism, growth, and evolution to the duration of seasons, succession, and life history, time is a primary dimension of biology. But despite its universal relevance, time is more often used as an independent variable or to characterize rates of change, than it is treated as a primary driver of change and biodiversity *per se*. The general influence of time  is so rarely mentioned that it may be self-evident, non-existent, or taken for granted. This is unlike the influence of other general variables, such as space and abundance.

**P2**—Law-like patterns such as the species-area relationship and the species-abundance distribution are central to the ecological study of biodiversity (Hubbell 2001, McGill 2010, Harte 2011). Yet, a similarly general time-related pattern (species-time relationship) is rarely studied and is neither central to nor predicted by general ecological theory (White, Adler et al.). While area and abundance are common inputs to biodiversity theories (McGill 2010), none use time as an input. And, while at least one popular ecological subfield is devoted to spatial dynamics, i.e., spatial ecology (16000 results on Google scholar), "temporal ecology" has yet to be considered a subfield (590 results on Google scholar) and if temporal dynamics are often along with space, i.e., "spatio-temporal". 

**P3**—The most general spatial principle is very simple, "near things are more similar than far things" (Tobler's Law) and even a precise knowledge of how abundance constrains diversity (cites), there is no general ecological rule or law relating to time. Unlike area, distance, abundance, and even the number of species (i.e., richness), there are no studies on the general influence of time on biodiversity. Other than the species-time relationship, there are no general time-related ecological patterns. Yet, at least one aspect of time applies to all components of any biological or ecological system, i.e., the amount of time that an individual organism, an amount of resource, a species, etc., remains in a system, i.e., residence time.

**P4**—Put simply, viable populations are maintained when individuals can reproduce before dying or emigrating but not so quickly that resource consumption exhausts the rate of supply. In this way, the timing of life history and population growth is constrained by residence time or even optimized for it (cite). This principle underpins the theory of the chemostat and makes residence time (τ) a master variable for controlling growth and biomass in experimental microcosms and engineered bioreactors. It also makes residence time among the most important variables influencing stability, function, and biodiversity in estuaries (cites). Yet, the influence of residence time is poorly known outside aquatic systems and though it is often manipulated to constrain growth and biomass, residence time has yet been framed as a general time-related constraint in any system, whether aquatic, terrestrial, or host-related. Yet, while many organisms are at the mercy of currents, all organisms are at the mercy of time.

**P5**—We examined the importance of residence time on the growth of populations, the assembly and structure of communities, and the evolution of trait combinations in highly complex systems. We propose that the residence time of a system should positively correlate with the residence times of its components (individuals, resources, species, traits, etc.). We then propose relationships of taxa and trait diversity based on the constraining influence of residence time. Finally, we propose the residence time distribution (RTD) as a general time-related ecological pattern that reveals many short-lived individuals, resources, species, etc., and few that are relatively long-lived. We examine factos influencing the RTD and test our predictions using an information-intensive individual-based model capable of simulating communities of competitively asymmetrical and physiologically unique species and individuals operating under trait evolution, sexual and clonal reproduction, fluid and non-fluid dynamics, variable resource efficiencies, dispersal dynamics, among others.


## METHODS

**Quantifying residence time—**In ideal systems (homogeneously mixed aquatic microcosms), residence time (τ) equals the ratio of volume to flow rate (τ = V/Q). Volume *per se* is not critical and the size of the system could also be quantified with area (A) and distance (D). This is easy to see by considering a perfect cube where residence times based on V, A, or D would be equal. That is, τ = V/Q = D^{3}/Q = D^{3}/(D^{3}/time) = time. The inverse of τ is dilution rate (τ^{-1}) and is the portion replaced per unit time, which often approximates growth rate. If τ^{-1} exceeds growth rate, then populations can be washed out. But, if τ^{-1} is too slow (i.e., τ is too long) then the supply resources may be too low to maintain actively growing populations.

**Residence time distribution (RTD)—**In ecological systems, V/Q may be a poor approximation of individual residence time and, at least, only represents one moment of an entire distribution. The amount of time that particles, individuals, etc., spend inside a system can be characterized with a frequency/probability distribution (MacMullin and Weber 1935, Danckwerts 1953). RTDs are used among engineers and hydrologists to characterize turnover, mixing, and flow and to compare the behavior of real systems to simplified models. In our individual-based modeling, we examine residence time distributions for individuals, resources, inert particles, species, traits, and any other aspect of the system that is not permanent.

**Predictions of highly correlated residence times—**As a starting prediction, residence times of individuals, resource particles, inert tracers, and most any non-permanent component of the system should be highly and positively correlated. That is, in general and without invoking a specific scenario, very short ecosystem residence times should not lead to long residence times for individual particles. 

**Right-skewed residence time distributions—**


**Predictions of abundance and species diversity—**

*Abundance*—Chemostat models predict a unimodal relationship between biomass or total abundance (*N*) and residence time (τ) when accounting for maintenance energy (cites). Sufficiently low τ can exclude reproduction while sufficiently high τ can mean a slow rate of resource resupply and immigration.

*Richness*—Changes in *N* are often associated with respective changes in the number of species (i.e. *S*). Richness must change as quickly or less quickly than *N*, i.e., species cannot be gained or lost faster than individuals. We expect the relationship of *S* to τ to follow a hump-shaped relationship, the slope of which must be equal to or shallower than the relationship of N to τ. Moreover, we expect *S* to share a power-law-like relationship with *N*, i.e., *S* = *cN*<sup>*z*</sup>, where z ~ 0.5, as has been observed by May (1988) and others (cite).  

*Evenness*—Similarity in abundance among species (evenness) should decrease with *N* due to numerical constraints (Locey and White 2013). We expect a relationship of evenness to τ that is opposite of that expected for *N*, i.e., a U-shaped relationship.

*Rarity*—


*Dominance*—


*Turnover*—A monotonically decreasing relationship β-diversity to τ—β-diversity is the heterogeneity in taxa among samples, either with respect to presence/absence or relative abundance (Tuomisto 2010). Regardless of processes or mechanisms, the most drastic changes in species turnover can occur when richness is low. We expect, species turnover to reach its greatest at lowest τ and to decrease monotonically thereafter because, as τ increases, the system becomes less likely to be colonized by other taxa.

**Trait-related predictions**

The unimodal relationship between growth rate and dilution rate (τ-1)—In simplified chemostats, dilution rate (τ-1) approximates specific (or population) growth rate. Exceptions are when dilution rate exceeds maximal growth rate and when dilution rate results in a rate of exogenous resource supply that is too low to support growth.

r vs. K selection

Generalist vs. specialist

Attachment vs. motility

Mass (M) vs. growth rate (B)—Larger body mass is strongly associated with whole organism metabolic rate (i.e., B ~ BoM3/4) but lower per unit metabolic rate (i.e., B/M ~ boM-1/4) (cite). Consequently, smaller organism require greater per cell maintenance energy than larger organisms, some of which is due to the greater surface area to volume ratio resulting in a greater rate of heat loss (cite).

Temperature-activity relationship—Active metabolism becomes costly to maintain in suboptimal temperatures as a consequence of physiological and environmental changes, e.g., unfavorable chemical kinetics, increased intracellular fluid viscosity, lack of liquid water, lack of exogenous resources (cite). Temperature is well-known to influence metabolic rates and the relationship of metabolic rate to body mass (cite). However, we expect that in a resource-poor environment with a thermal gradient that organisms in lower temperatures could more easily pursue a dormant strategy and hence, avoid starvation. 

Modeling

Individual-based—We used a spatially explicit individual-based simulation model where individuals and information about individuals are tracked through time. Growth, reproduction, and death are simulated via weighted random sampling that, unlike neutral models, simulates a probabilistic nature of environmental filtering and competition. Resources and individuals enter, flow through, and exit the system according to a combination of fluid and diffusion dynamics. The model is parameterized with metacommunity, local community, ecosystem, species, and individual level parameters (Table 1). The values of the parameters determine the degree of variation among species and are chosen at random by the simulation framework. These parameters can theoretically vary from species-neutral (i.e. all species are the same) to idiosyncratic (i.e. all species are different) but nearly always include some degree of species difference in growth rate, maintenance energy, etc. (Table 1). The model operates in two spatial dimensions, and there is one upstream side and one downstream side.

Fluid flow—We used a Lattice-Boltzmann Method (LBM) to simulate movement through a fluid environment. LBMs are powerful and relatively new tools used in computational fluid dynamics, and as we show, can be used in ecology to simulate the realistic fluid flow of individuals, resource, or both (cite). LBMs discretize the environment into a lattice and attach to each position in the lattice a number of particle densities and velocities for each of nine directions of movement. Here, individual organisms and resource particle have x-y coordinates that can change (e.g. in the ideal chemostat simulation) according to the velocity of the environment at those positions (see Appendix for greater details).

Diffusion—We used simulated random walks to move resources and/or individuals through the environment via diffusion. Random walks are commonly used in ecology to model either stochastic physical movement or stochastic demographic changes where the state of an individual or population in the next time step is a random change in magnitude and direction (velocity) that is influenced by the current state; as opposed to a white-noise process where the magnitude of change in position is uniformly random and uncorrelated from step to step.

Simulated life history—In each case, the model simulated life history processes as follows: Resources and individuals flow into a system from the upstream edge of the environment. Species identities of inflowing propagules are chosen at random from a log-series distribution, which often approximates the distribution of abundance among taxa in ecological communities (Hubbell 2001, White et al. 2012). Along with a species ID and species-specific maximum rate of uptake, each propagule is given an individual ID (computer clock-time at which the individual entered), and a cell quota to represent the physiological state of internal resources. 
The community was sampled at random N times with replacement for each simulated time unit. This theoretically gives every individual the opportunity to grow and reproduce. Sampled individuals consume resources according to species specific rates of uptake, if there is a resource present at the individual’s location. Uptake increases the individual cell quota and decreases ambient resources within the immediate location of the individual. The individual’s quota is then decreased according to a species specific physiological maintenance cost. Individuals then reproduce with a probability equal to their cell quota and results in an equal  division of the cell quota between the individual and its daughter. The daughter is given a unique individual ID which is appended to the species ID of its mother, to maintain heritage. Sampled individuals die if their cell quota is less than or equal to 0. Individuals and resource particles flow out when they pass the downstream edge of the environment.

Simulated environmental complexity—We constructed the model to capture environmental heterogeneity and the aggregation of resources and individuals. The model was parameterized with an arbitrary environmental gradient that varied regularly across a randomly chosen spatial axis in a randomly chosen direction. Barriers were constructed within the environment to prevent unhindered flow and to generate aggregation and realistic hydrological flow.

Simulated species differences—To allow species differences in physiological traits and environmental optima, we allowed species-specific values for maximum rate of uptake rate, environmental optima, and maintenance costs to be normally distributed random variables where both the means and the standard deviations of the sampling distributions were chosen at random at the start of the simulations. Whenever an individual of a new species entered the local community, values for maximum uptake rate, environmental optima, physiological maintenance cost, and minimum cell quota were chosen at random according to the respective normal distributions for those variables.

Evaluating model performance in real-time—The model simulates over thousands of generations until a state of stationarity is reached. Because increasing values of τ leads to slow population dynamics and because the simulations can vary over three orders of magnitude in τ, we designed the model to track its own performance to ensure that time points gathered from the model were not taken during ‘burn in’ and to ensure time points were not auto-correlated. For each generation (i.e. a number of time steps equal to N, which is not constant) after the first 1000 generations, the model evaluates whether it has reached stationarity by calculating the value of the Hurst exponent (H) and the p-value of the variance ratio test for values of N recorded from the last 500 generations. Stationarity is assumed to be reached when H < 0.5 and p < 0.05 (cite). All time points before this ‘burn-in’ period are discarded. After reaching stationarity, the model runs for another 1000 generations and then stops to check if there are at least 100 sufficiently non-autocorrelated time points, as determined by the time lag after which absolute values of the autocorrelation function are less than 0.1. If not, the model runs for another 1000 generations, repeating the process until 100 non-autocorrelated time points is obtained.

Simulating over residence time (τ)—We ran the model to quasi-equilibrium for each value of τ in a series of values spanning more than two orders of magnitude, starting with τ = 0.001 and then doubling until τ = 0.512. The model was run with the same combination of resource, community ecological, and environmental (thermal, physicochemical, physical complexity) values for each value of τ in the series. After running over all τ values, the model was re-parameterized at random with a new combination of resource parameters (size, number, and types of resource particles), habitat complexity parameters (size, number, and types of physical barriers), chemical environmental parameters, thermal parameters (average temperature, direction and severity of temperature gradient), and average community-level values (average specific values for uptake rate, maintenance, individual size, motility, attachment). See table 1.   
	

	Because the model is individual-based, information intensive, physiologically realistic, ecologically complex, fluid dynamic, self-evaluating, it cannot be run over arbitrarily slow or fast residence times. During each simulation, more than a gigabyte of information is held in memory. This is unlike analytically tractable and computationally simple Markov models or closed-form analytical models, which are more useful for obtaining precise quantitative predictions according to a single theoretical framework via traditional mathematical tools, but are less useful for modeling highly complex multivariate problems and for examining how individual-level interactions lead to aggregate behaviors. In our case, we have integrated components from metabolic theory and ecological scaling, neutral and niche theory, metacommunity theory, fluid dynamics, chemostat theory, and life history theory into a self-evaluating model that tracks the life history, location, and heritage of millions of individuals.

We used a stochastic individual-based model that simulated a wide array of environmental and ecological conditions and species-level and individual-level traits. As much of this variation as possible was assigned at random, to explore a large swath of multi-parameter space. Rather than examine the independent influence of each of these factors, our purpose was to find whether simple relationships of residence time to total abundance and community-level characteristics should hold in ecologically complex conditions.

## Conclusion






```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
rm(list=ls()) 
getwd() 
setwd("~/GitHub/hydrobide") 
```




```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
#install.packages("vegan") 
require("vegan") 
```


```{r, results = 'hide', message = FALSE, warning = FALSE}
## Load Data
sim.data <- read.csv("~/GitHub/hydrobide/results/simulated_data/2015_June/18_June_3/SimData.csv")  
sim.data <- subset(sim.data, motion == ' fluid ')
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
## Assign Data
sim <- sim.data$sim # the specific simulation run
height <- sim.data$Height
width <- sim.data$Width
flow.rate <- sim.data$FlowRate
seed <- sim.data$starting.seed

h.tau <- log((height * width)/flow.rate)
m.tau <- log(sim.data$individual.tau)
t.tau <- log(sim.data$particle.tau)

N <- sim.data$N
S <- sim.data$S
e.var <- sim.data$e.var
e.simp <- sim.data$simpson.e
avg.ab <- N/S
Skew <-sim.data$skew
Nmax <- sim.data$N.max
SimpD <- sim.data$SD

res.inflow <- sim.data$res.inflow
res.types <- sim.data$res.types
max.res.val <- sim.data$max.res.val

res.conc <- sim.data$resource.concentration
num.tracers <- sim.data$tracer.particles
num.resources <- sim.data$resource.particles
```


## Univariate relationships

```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
par(mfrow=c(1, 2))

num.sims <- max(sim.data$sim)
colors <- rainbow(num.sims)

i <- 0
while (i < num.sims){

  sim.sub <- subset(sim.data, sim == i)
  i <- i + 1
  print(i)
  
  height <- sim.sub$Height
  width <- sim.sub$Width
  flow.rate <- sim.sub$FlowRate
  e.var <- sim.sub$e.var
  e.simp <- sim.sub$simpson.e
  avg.ab <- N/S
  Skew <-sim.sub$skew
  Nmax <- sim.sub$N.max
  SimpD <- sim.sub$SD

  h.tau <- log((height * width)/flow.rate)

  N <- sim.sub$N
  N <- log(N)
  S <- sim.sub$S
  S <- log(S)

  x <- c()
  y <- c()
  ct <- 1
  for (val in N){
    if(is.nan(val) == FALSE && val > 0.1){
      y <- c(y, val)
      x <- c(x, h.tau[ct])
      }
    ct <- ct+1
    }

  if (i == 1){
    plot(x, y, xlab="log(ecosystem residence time)", 
    ylab="Total Abundance", ylim=c(3.5, 10), xlim=c(3, 9),
    main = "N vs. Tau", col=colors[i])
    lines(x, y, col=colors[i])
    }
  else{
    points(x, y, col=colors[i])
    lines(x, y, col=colors[i])
    }
  
  }
  
i <- 0
while (i < num.sims){

  sim.sub <- subset(sim.data, sim == i)
  i <- i + 1
  
  height <- sim.sub$Height
  width <- sim.sub$Width
  flow.rate <- sim.sub$FlowRate
  e.var <- sim.sub$e.var
  e.simp <- sim.sub$simpson.e
  avg.ab <- N/S
  Skew <-sim.sub$skew
  Nmax <- sim.sub$N.max
  SimpD <- sim.sub$SD

  h.tau <- log((height * width)/flow.rate)
  S <- sim.sub$S
  S <- log(S)

  x <- c()
  y <- c()
  ct <- 1
  for (val in S){
    if(is.nan(val) == FALSE && val > 0.1){
      y <- c(y, val)
      x <- c(x, h.tau[ct])
      }
    ct <- ct+1
    }

  if (i == 1){
    plot(x, y, xlab="log(ecosystem residence time)", 
    ylab="log(species richness)", ylim=c(0, 4), xlim=c(3, 9),
    main = "S vs. Tau", col=colors[i])
    lines(x, y, col=colors[i])
    }
  else{
    points(x, y, col=colors[i])
    lines(x, y, col=colors[i])
    }
}
```



```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
## Reassign Data

sim <- sim.data$sim # the specific simulation run
height <- sim.data$Height
width <- sim.data$Width
flow.rate <- sim.data$FlowRate
seed <- sim.data$starting.seed

h.tau <- log((height * width)/flow.rate)
m.tau <- log(sim.data$individual.tau)
t.tau <- log(sim.data$particle.tau)

N <- sim.data$N
S <- sim.data$S
e.var <- sim.data$e.var
e.simp <- sim.data$simpson.e
avg.ab <- N/S
Skew <-sim.data$skew
Nmax <- sim.data$N.max
SimpD <- sim.data$SD

res.inflow <- sim.data$res.inflow
res.types <- sim.data$res.types
max.res.val <- sim.data$max.res.val

res.conc <- sim.data$resource.concentration
num.tracers <- sim.data$tracer.particles
num.resources <- sim.data$resource.particles
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
par(mfrow=c(1, 2))

growth <- sim.data$avg.per.capita.growth
x <- c()
y <- c()

ct <- 1
for (val in growth){
  if(is.nan(val) == FALSE && val > 0.1){
    y <- c(y, val)
    x <- c(x, h.tau[ct])
    }
  ct <- ct+1
  }

plot(x, y, xlab="log(ecosystem residence time)", 
     ylab="growth rate", 
     main = "Per capita growth vs. Tau",
     col='dodgerblue')

maint <- (S*sim.data$avg.per.capita.maint)/N
plot(h.tau, log(maint), xlab="log(ecosystem residence time)", 
     ylab="log(maintenance)", 
     main = "Per capita maintenance vs. Tau",
     col='darkolivegreen')
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=7}
par(mfrow=c(2, 2))

plot(log(N), Skew, xlab="Total abundance", 
     ylab="Skewness",
     main = "Rarity vs. N",
     col='plum')

plot(log(N), log(Nmax), xlab="Total abundance", 
     ylab="Nmax", 
     main = "Nmax vs. N",
     col='darkorange')

plot(log(N), log(e.var), xlab="Total abundance", 
     ylab="Species Evenness", 
     main = "Evenness vs. N",
     col='lightseagreen')

plot(log(N), log(S), xlab="Total abundance",
     ylab="Species Richness", 
     main = "S vs. N",
     col='indianred')

```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
par(mfrow=c(1, 2))

xlabel <- "log(ecosystem residence time)"
res.conc <- sim.data$resource.concentration
res.div <- sim.data$shannons.resource.diversity
res.rich <- sim.data$resource.richness

x <- c()
y <- c()
ct <- 1
for (val in res.conc){
  if(is.nan(val) == FALSE && val > 0.1){
    y <- c(y, val)
    x <- c(x, h.tau[ct])
    }
  ct <- ct+1
  }

plot(x, log(y), xlab=xlabel, 
     ylab="density", 
     main = "Resource density vs. Tau",
     col='peru')


x <- c()
y <- c()
ct <- 1
for (val in res.rich){
  if(is.nan(val) == FALSE && val > 0.1){
    y <- c(y, val)
    x <- c(x, h.tau[ct])
    }
  ct <- ct+1
  }

plot(x, y, xlab=xlabel, 
     ylab="Number of resource types", 
     main = "Resource richness vs. Tau",
     col='slateblue')
```



```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
rads <- list()
rad.list <- read.table("~/GitHub/hydrobide/results/simulated_data/2015_June/18_June_3/RADs.csv",
            header = FALSE, sep = ",", col.names = paste0("V", seq_len(1000)),
            as.is = TRUE, skipNul = TRUE, fill = TRUE)

rad.list[is.na(rad.list)] <- 0
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
species <- list()
species.list <- read.table("~/GitHub/hydrobide/results/simulated_data/2015_June/18_June_3/Species.csv",
            header = FALSE, sep = ",", col.names = paste0("V", seq_len(1000)),
            as.is = TRUE, skipNul = TRUE, fill = TRUE)

species.list[is.na(species.list)] <- -1
```



