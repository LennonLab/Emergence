---
title: "Basic Analysis of Simplex output"
author: "Ken Locey"
date: "October 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## OVERVEW

This R Markdown document is designed to be opened and ran in the RStudio. The chunks of code below allow for basic analysis of **simplex** output. This includes univariate and multivariate relationships, and graphical exploration.

For an R-based introduction to multivariate analysis: https://little-book-of-r-for-multivariate-analysis.readthedocs.org/en/latest/src/multivariateanalysis.html 

## SETUP
## A. Clear and set the working directory

```{r, results = 'hide', echo=T, message = F, warning = F}
rm(list=ls()) 
getwd()
setwd("~/GitHub/simplex") 
```

## B. Import packages; install if needed

```{r, results = 'hide', echo=T, message = F, warning = F}
#install.packages("vegan") # Example of how an install can be done
require("vegan") 
require("car")
```

## C. Import simulated data generated by simplex models

As it is iterating through randomly assembled models, simplex writes its output to six .csv files. For each file, each row corresponds to a single model. Consequently, the *i*th row in each file corresponds to *i*th model that was assembled and run by simplex. Let's import the simulated data files.

```{r, results = 'hide', echo=T, message = F, warning = F}
# A table where each columns corresponds to a state variable or model output.  
simplex.dat <- read.csv("~/GitHub/simplex/results/simulated_data/examples/SimData.csv")

simplex.dat <- simplex.dat[complete.cases(simplex.dat), ]
simplex.dat$tau <- (simplex.dat(width)*simplex.dat(height))/simplex.dat(flow.rate)

simplex.dat$total.abundance[simplex.dat$total.abundance<=0] <- 0.00001
simplex.dat$N.max[simplex.dat$N.max<=0] <- 0.00001
simplex.dat$species.richness[simplex.dat$species.richness<=0] <- 0.00001
simplex.dat$resource.particles[simplex.dat$resource.particles<=0] <- 0.00001
simplex.dat$resource.concentration[simplex.dat$resource.concentration<=0] <- 0.00001
simplex.dat$Whittakers.turnover[simplex.dat$Whittakers.turnover<=0] <- 0.00001
simplex.dat$Jaccards.dissimilarity[simplex.dat$Jaccards.dissimilarity<=0] <- 0.00001

simplex.dat$total.abundance <- log(simplex.dat$total.abundance)
simplex.dat$N.max <- log(simplex.dat$N.max)
simplex.dat$Whittakers.turnover <- log(simplex.dat$Whittakers.turnover)
simplex.dat$Jaccards.dissimilarity <- log(simplex.dat$Jaccards.dissimilarity)
simplex.dat$species.richness <- log(simplex.dat$species.richness)
simplex.dat$resource.particles <- log(simplex.dat$resource.particles)
simplex.dat$resource.concentration <- log(simplex.dat$resource.concentration)

```


## UNIVARIATE ANALYSES

Perhaps we want to ask whether **simplex** produces (i) relationships that are well-known to occur in ecological systems (ii) auto-correlated relationships between independent variables (iii) or novel relationships of use to a specific study or question. Each of these questions has its particular use, but rather than generate one x-y relationship after another, we generate an entire field of relationships. That is, given x variables, we can explore x*(x-1) x-y relationships.

Let's begin by examining relationships between some physical variables. As we'll see, the only physical variables that appear to be correlated are ecosystem residence time and the rate of flow.

```{r, results='hide', echo=T, message=F, warning=F, fig.width=7, fig.height=6}
# Physical and metacommunity variables
png(filename="~/GitHub/simplex/results/figures/examples/PhysicalUnivariate.png")

phys.dat <- as.matrix(subset(simplex.dat, 
                      select = c(tau
                                 flow.rate,
                                 barriers,
                                 width,
                                 height,
                                 amplitude)))

scatterplotMatrix(phys.dat, main="Physical data", diagonal = "none")
dev.off()
```


Next, let's explore relationships between some resource-related variables. As we'll see, the number of resource particles, their concentration, resource richness or the number of resource types, and resource diversity (a combination of resource richness and the variance in abundance among resources) are all highly and positively correlated.

```{r, results='hide', echo=T, message=F, warning=F, fig.width=7, fig.height=6}
# Resource variables
png(filename="~/GitHub/simplex/results/figures/examples/ResourceUnivariate.png")

res.dat <- as.matrix(subset(simplex.dat, 
                      select = c(resource.concentration,
                      shannons.resource.diversity,
                      resource.richness,
                      resource.particles)))

scatterplotMatrix(res.dat, main="Resource data", diagonal = "none")
dev.off()
```


We can also explore relationships between physiological variables, noticing that, biomass production in Carbon, Nitrogen, and Phosphorus are all positively and strongly correlated. This is largely because **simplex** (as of 26 October 2015) does not include any explicit stoichiometry. Also notice that an interesting life history trade-off arises in **simplex** however, that is, increasing growth rate leads to increasing metabolic maintenance.

```{r, results='hide', echo=T, message=F, warning=F, fig.width=7, fig.height=6}
# Physiological variables
png(filename="~/GitHub/simplex/results/figures/examples/PhysioUnivariate.png")

physio.dat <- as.matrix(subset(simplex.dat, 
                      select = c(biomass.prod.N,
                      avg.per.capita.N.efficiency,
                      max.growth.rate,
                      max.met.maint)))

scatterplotMatrix(physio.dat, main="Physiological data", diagonal = "none")
dev.off()
```


Finally, let's explore relationships between some diversity related variables. As we can see different evenness measure basically reflect each other, as do different measures of species turnover. Likewise, we see a strong postivie relationships between total abundance and species richness and between total abundance and the abundance of the most abundant species; which we should expect.

```{r, results='hide', echo=T, message=F, warning=F, fig.width=7, fig.height=6}
# Diversity-related variables
png(filename="~/GitHub/simplex/results/figures/examples/DiversityUnivariate.png")

diversity.dat <- as.matrix(subset(simplex.dat, 
                      select = c(total.abundance,
                      N.max,
                      species.richness,
                      simpson.e,
                      Whittakers.turnover,
                      Jaccards.dissimilarity)))

scatterplotMatrix(diversity.dat, main="Diversity data", diagonal = "none")
dev.off()
```


## Summary statistics

We can use the 'sapply' function to generate summary statistics (mean, variance, etc.) column by column for any of our **simplex** output. For example, analyzing phys.dat as a data.frame:

```{r, results='show', echo=T, message=F, warning=F}
sapply(as.data.frame(phys.dat), mean) # sample mean
sapply(as.data.frame(phys.dat), var) # sample variance
sapply(as.data.frame(phys.dat), sd) # sample standard deviation
sapply(as.data.frame(phys.dat), median) # sample median
```


## HIGHLY CORRELATED VARIABLES

Suppose we want to find the most highly correlated variables in our data. First, lets define a function to return the x most highly correlated variables in a dataframe.

```{r, results='hide', echo=F, message=F, warning=F}
# This function was obtained from: https://little-book-of-r-for-multivariate-analysis.readthedocs.org/en/latest/src/multivariateanalysis.html

mosthighlycorrelated <- function(mydataframe, numtoreport)
  {
     # find the correlations
     cormatrix <- cor(mydataframe)
     # set the correlations on the diagonal or lower triangle to zero,
     # so they will not be reported as the highest ones:
     diag(cormatrix) <- 0
     cormatrix[lower.tri(cormatrix)] <- 0
     # flatten the matrix into a dataframe for easy sorting
     fm <- as.data.frame(as.table(cormatrix))
     # assign human-friendly names
     names(fm) <- c("First.Variable", "Second.Variable","Correlation")
     # sort and print the top n correlations
     head(fm[order(abs(fm$Correlation), decreasing=T),], n=numtoreport)
  }
```


Then, let's call our function to find the x most highly correlated variables.

```{r, results='show', echo=T, message=F, warning=F}
dat <- cbind(phys.dat, physio.dat, res.dat, diversity.dat)
mosthighlycorrelated(dat, 15)
```


## Variance partitioning.

A common question to ask is whether physical variables (geograhic distance, area, volume, flow rate, etc.) has a larger influence on ecological diversity than, say, resource-related variables.

One way to address this question is to use variance partitioning. A note of caution, typing 'help(varpart)' reveals that R only uses (simple) linear regression when there is one response variable and uses redundancy analysis ordination (RDA) for two or more response variables.

Executing the code below shows that, in **simplex** models, the phys variables explain more variation in total abundance, and species richness, evenness, and turnover than do resource related variables.


```{r, results='hide', echo=F, message=F, warning=F, fig.width=7, fig.height=4}
diversity.dat <- as.matrix(subset(simplex.dat, 
                      select = c(total.abundance,
                      species.richness,
                      simpson.e,
                      Whittakers.turnover)))

rda.phys <- rda(diversity.dat ~ phys.dat)
rda.phys
rda.res <- rda(diversity.dat ~ res.dat)
rda.res

# Test significance of the fractions using RDA:
phys.anova <- anova(rda.phys, step=200, perm.max=200)
phys.anova
res.anova <- anova(rda.res, step=200, perm.max=200)
res.anova

# Variance partitioning with two explanatory matrices
mod <- varpart(Y=diversity.dat, X=phys.dat, res.dat)
mod
showvarparts(2)
plot(mod)
mtext("Variation partitioning")
text(1.1, 0.5, "env")
text(-0.1, 0.5, "phys") 
```

