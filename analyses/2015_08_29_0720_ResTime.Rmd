---
title: "Residence time, a master variable of ecology, physiology, and natural selection"
author: "Ken Locey, Jay Lennon"
date: "June, 2015"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
rm(list=ls()) 
getwd() 
setwd("~/GitHub/hydrobide") 
```

```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
#install.packages("vegan") 
require("vegan") 
#install.packages("moments")
require("moments")
library(ggplot2)
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
## Loading files with plotting and diversity functions
source("~/GitHub/hydrobide/tools/Rbin/multiplot.R")
source("~/GitHub/hydrobide/tools/Rbin/metrics.R")
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE}
## Load Data
sim.data <- read.csv("~/GitHub/hydrobide/results/simulated_data/2015_August/29_Aug/SimData.csv")  
h.tau <- (sim.data$height * sim.data$width)/sim.data$flow.rate
sim.data$total.abundance[sim.data$total.abundance<=0] <- 1
sim.data$species.richness[sim.data$species.richness<=0] <- 1

sim.data.fluid <- subset(sim.data, motion == "fluid")
h.tau.fluid <- (sim.data.fluid$height * sim.data.fluid$width)/sim.data.fluid$flow.rate
sim.data.fluid$total.abundance[sim.data.fluid$total.abundance<=0] <- 1
sim.data.fluid$species.richness[sim.data.fluid$species.richness<=0] <- 1

sim.data.random_walk <- subset(sim.data, motion == "random_walk")
h.tau.random_walk <- (sim.data.random_walk$height * sim.data.random_walk$width)/sim.data.random_walk$flow.rate
sim.data.random_walk$total.abundance[sim.data.random_walk$total.abundance<=0] <- 1
sim.data.random_walk$species.richness[sim.data.random_walk$species.richness<=0] <- 1
```

## We hypothesized that total abundance (N) and species richness (S) shared humped-shaped relationshiped with residence time, reflecting chemostat theory.

```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/NandS_vs_ResTime.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "black")

p1 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$total.abundance, group=sim.data$sim, colour=sim.data$sim)) +
  scale_color_gradient(high="cyan") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Individuals") +
  labs(title="Total abundance") +
  guides(colour=FALSE) + 
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = .50)

p2 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$species.richness, group=sim.data$sim, colour=sim.data$sim)) +
  scale_color_gradient(high="chartreuse") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Number of species") +
  labs(title="Species richness") +
  guides(colour=FALSE) +
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = 1.0)

multiplot(p1, p2, cols=2)
dev.off()
```


```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/NandS_vs_ResTime_ByMotion.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "black")

p1 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$total.abundance, group=sim.data$sim, colour=sim.data$motion)) +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Individuals") +
  labs(title="Total abundance") +
  guides(colour=FALSE) + 
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = .50)

p2 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$species.richness, group=sim.data$sim, colour=sim.data$motion)) +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Number of species") +
  labs(title="Species richness") +
  guides(colour=FALSE) +
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = 1.0)

multiplot(p1, p2, cols=2)
dev.off()
```



```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/NandS_vs_ResTime_2ByMaxGrowthRate.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "black")

p1 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$total.abundance, group=sim.data$sim, 
                           colour=sim.data$max.growth.rate)) +
  scale_color_gradient(high="cyan") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Individuals") +
  labs(title="Total abundance") +
  guides(colour=FALSE) + 
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = .50)

p2 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$species.richness, group=sim.data$sim, 
                           colour=sim.data$max.growth.rate)) +
  scale_color_gradient(high="cyan") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Number of species") +
  labs(title="Species richness") +
  guides(colour=FALSE) +
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = 1.0)

multiplot(p1, p2, cols=2)
dev.off()
```



```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/NandS_vs_ResTime_ByMaxActiveDisp.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "black")

p1 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$total.abundance, 
  group=sim.data$sim, colour=sim.data$max.active.dispersal)) +
  scale_color_gradient(high="darkseagreen") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Individuals") +
  labs(title="Total abundance") +
  guides(colour=FALSE) + 
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = .50)

p2 <- ggplot(sim.data, aes(x=h.tau, y=sim.data$species.richness, group=sim.data$sim, colour=sim.data$motion)) +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Number of species") +
  labs(title="Species richness") +
  guides(colour=FALSE) +
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = 1.0)

multiplot(p1, p2, cols=2)
dev.off()
```

## We hypothesized that the realtionship species evenness (E) to residence time would be U-shaped, and that the relationship of species turnover (B) to residence time would be L-shaped.

```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/EandB_vs_ResTime.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "black")

p1 <- ggplot(sim.data, aes(x=h.tau, y=e.var, group=sim, colour=sim)) +
  scale_color_gradient(high="cyan") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Evar") +
  labs(title="Evenness") +
  guides(colour=FALSE) + 
  scale_x_log10() + 
  coord_fixed(ratio = 1.8)

p2 <- ggplot(sim.data, aes(x=h.tau, y=Whittaker.turnover, group=sim, colour=sim)) +
  scale_color_gradient(high="chartreuse") +
  geom_smooth(mapping=NULL, data=NULL, se=F, stat="smooth") +
  theme_black() +
  labs(x= expression(tau), y="Whittaker's") +
  labs(title="Species turnover") +
  guides(colour=FALSE) +
  scale_x_log10() +
  coord_fixed(ratio = 2.0)

multiplot(p1, p2, cols=2)
dev.off()
```


## We expected lower maintenance requirements at higher residence times, where individuals could grow quickly, scrambling to consume available resources, or have an overall slow life history.

```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=4}
plot.new()
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/Growth_and_Maint.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "black")

growth <- sim.data$avg.per.capita.growth
xs <- c()
ys <- c()

ct <- 1
for (val in growth){
  if(is.nan(val) == FALSE && val > 0.1){
    ys <- c(ys, val)
    xs <- c(xs, h.tau[ct])
    }
  ct <- ct+1
  }

p1 <- ggplot(data=NULL, aes(x=xs, y=ys)) +
  geom_point(colour="magenta") +
  labs(x= expression(tau), y="Growth") +
  labs(title="Growth rate") +
  scale_x_log10() +
  coord_fixed(ratio = 100) +
  theme_black()

#maint <- (S*sim.data$avg.per.capita.maint)/N
maint <- sim.data$avg.per.capita.maint

p2 <- ggplot(data=NULL, aes(x=h.tau, y=maint)) +
  geom_point(colour="cyan") +
  labs(x= expression(tau), y="Maintenance") +
  labs(title="Maintenance") +
  scale_x_log10() +
  scale_y_log10() +
  coord_fixed(ratio = 8) +
  theme_black()


multiplot(p1, p2, cols=2)
dev.off()
```


## We hypothesized that aspects of diversity would be related to total abundance (N), reflecting the feasible set and the influence of residence time.

```{r, results = 'hide', echo=FALSE, message = FALSE, warning = FALSE, fig.width=7, fig.height=7}
plot.new()
png(filename = '~/GitHub/hydrobide/results/figs/29_Aug/Diversity_vs_N.png',
      width = 700, height = 500, units = "px", pointsize = 17, bg = "white")

par(mfrow=c(2, 2))

plot(N, Skew, xlab="Total abundance", log="xy",
     ylab="Skewness",
     main = "Rarity vs. N",
     col='plum')

plot(N, Nmax, xlab="Total abundance", log="xy",
     ylab="Nmax", 
     main = "Nmax vs. N",
     col='darkorange')

plot(N, e.var, xlab="Total abundance", log="xy",
     ylab="Species Evenness", 
     main = "Evenness vs. N",
     col='lightseagreen')

plot(N, S, xlab="Total abundance", log="xy",
     ylab="Species Richness", 
     main = "S vs. N",
     col='indianred')

dev.off()
```
